# name: Local Test - CI/CD Next.js

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# jobs:
#   build-and-test-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: ðŸ›’ Checkout repository
#         uses: actions/checkout@v4

#       - name: âš™ï¸ Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: ðŸ“¦ Install dependencies
#         run: npm ci

#       - name: ðŸ—ï¸ Build Next.js app
#         run: npm run build

#       - name: ðŸ” Verify build output
#         run: |
#           echo "ðŸ“ Current directory: $(pwd)"
#           if [ -d ".next" ]; then
#             echo "âœ… .next directory exists:"
#             ls -la .next
#           else
#             echo "âŒ .next directory not found!"
#             exit 1
#           fi

#       - name: ðŸ—œï¸ Compress .next folder
#         run: |
#           tar -czf next-build.tar.gz .next
#           echo "âœ… Created archive:"
#           ls -lh next-build.tar.gz

#       - name: ðŸš€ Upload build artifact (for testing)
#         uses: actions/upload-artifact@v4
#         with:
#           name: next-build
#           path: next-build.tar.gz

#       - name: ðŸ“¦ Simulate "Deploy" locally
#         run: |
#           mkdir -p deploy_output
#           cp next-build.tar.gz deploy_output/
#           cd deploy_output
#           tar -xzf next-build.tar.gz
#           echo "âœ… Simulated deployment complete:"
#           ls -la .next

#       - name: âœ… Verify simulated deployment
#         run: |
#           echo "App deployed to local 'deploy_output' folder!"
#           ls -la deploy_output/.next



# name: CI/CD - Next.js Build & Windows Deploy (12:01 AM IST)

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:
#   schedule:
#     - cron: "31 18 * * *" # 12:01 AM IST (18:31 UTC)

# jobs:
#   build-and-deploy:
#     runs-on: windows-latest

#     steps:
#       # ------------------ CI: BUILD ------------------
#       - name: ðŸ›’ Checkout repository
#         uses: actions/checkout@v4

#       - name: âš™ï¸ Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: ðŸ“¦ Install dependencies
#         run: npm ci
#         shell: powershell

#       - name: ðŸ—ï¸ Build Next.js app
#         run: npm run build
#         shell: powershell

#       - name: ðŸ—œï¸ Create build archive
#         run: |
#           if (Test-Path "next-build.tar.gz") { Remove-Item next-build.tar.gz -Force }
#           tar -czf next-build.tar.gz .next
#           Write-Host "âœ… Build archived successfully."
#         shell: powershell

#       # ------------------ CD: DEPLOY ------------------
#       - name: ðŸš€ Deploy to Windows Server via WinRM
#         shell: pwsh
#         env:
#           SERVER_HOST: ${{ secrets.SERVER_HOST }}
#           SERVER_USER: ${{ secrets.SERVER_USER }}
#           SERVER_PASS: ${{ secrets.SERVER_PASS }}
#         run: |
#           Write-Host "ðŸ”§ Configuring WinRM client on GitHub runner..."
#           winrm set winrm/config/client '@{AllowUnencrypted="true"}'
#           winrm set winrm/config/client/auth '@{Basic="true"}'
#           winrm set winrm/config/client '@{TrustedHosts="*"}'
#           Write-Host "âœ… WinRM client configured and TrustedHosts set."

#           Write-Host "ðŸ”— Connecting to $env:SERVER_HOST ..."
#           $secpass = ConvertTo-SecureString $env:SERVER_PASS -AsPlainText -Force
#           $creds = New-Object System.Management.Automation.PSCredential ($env:SERVER_USER, $secpass)
#           $session = New-PSSession -ComputerName $env:SERVER_HOST -Port 5985 -Credential $creds -Authentication Basic -UseSSL:$false

#           Write-Host "ðŸ“¦ Uploading build to remote server..."
#           Copy-Item -ToSession $session -Path "next-build.tar.gz" -Destination "C:\inetpub\wwwroot\next-app\next-build.tar.gz" -Force

#           Invoke-Command -Session $session -ScriptBlock {
#             Write-Host "ðŸ”§ Preparing deploy folder..."
#             if (!(Test-Path "C:\inetpub\wwwroot\next-app")) {
#               New-Item -ItemType Directory -Path "C:\inetpub\wwwroot\next-app" | Out-Null
#             }

#             Set-Location "C:\inetpub\wwwroot\next-app"
#             Write-Host "ðŸ“‚ Extracting build..."
#             tar -xzf next-build.tar.gz
#             Remove-Item next-build.tar.gz -Force
#             Write-Host "âœ… Build extracted successfully."

#             Write-Host "ðŸ”„ Restarting Next.js app with PM2..."
#             pm2 restart next-app -f -s 2>$null
#             if ($LASTEXITCODE -ne 0) {
#               Write-Host "App not found â€” starting a new PM2 process."
#               pm2 start npm --name "next-app" -- run start
#             }

#             # Log deployment timestamp
#             $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
#             Add-Content "C:\inetpub\wwwroot\next-app\deploy-log.txt" "Deployed at $timestamp"
#             Write-Host "ðŸš€ Deployment completed and logged."
#           }

#           Remove-PSSession $session





name: CI/CD - Next.js Build & Windows Deploy

on:
  push:
    branches: ["main"]
  # Allows manual runs from the GitHub UI
  workflow_dispatch:
  # Keeps the existing scheduled run
  schedule:
    - cron: "31 18 * * *" # 12:01 AM IST (18:31 UTC)

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # ------------------ CI: BUILD ------------------
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        run: npm ci
        shell: powershell

      - name: ðŸ—ï¸ Build Next.js app
        run: npm run build
        shell: powershell

      - name: ðŸ—œï¸ Create build archive (Include all necessary files for PM2)
        run: |
          if (Test-Path "next-build.tar.gz") { Remove-Item next-build.tar.gz -Force }
          # Archive the .next folder PLUS the package.json and node_modules (if needed, but typically cheaper to install on server)
          # For Next.js Standalone/PM2, you usually need the full project structure.
          # Assuming your deployment structure only needs .next, but adjust this if other files (like package.json) are needed for the PM2 start command.
          tar -czf next-build.tar.gz .next package.json
          Write-Host "âœ… Build archived successfully."
        shell: powershell

      # ------------------ CD: DEPLOY ------------------
      - name: ðŸš€ Deploy to Windows Server via Secure WinRM (Port 5986)
        shell: pwsh
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          Write-Host "ðŸ”§ Configuring WinRM client on GitHub runner..."
          # Set Basic Auth for user/pass credentials
          winrm set winrm/config/client/auth '@{Basic="true"}'
          # Set TrustedHosts to allow connection to the server name/IP
          winrm set winrm/config/client '@{TrustedHosts="*"}'
          Write-Host "âœ… WinRM client configured and TrustedHosts set."

          Write-Host "ðŸ”— Connecting securely to $env:SERVER_HOST on Port 5986 (HTTPS)..."
          
          # 1. Define session options to skip SSL/Certificate checks (necessary for self-signed certificates)
          $sessionOption = New-PSSessionOption -SkipCertificateCheck -SkipCNCheck
          
          # 2. Create the PSCredential object
          $secpass = ConvertTo-SecureString $env:SERVER_PASS -AsPlainText -Force
          $creds = New-Object System.Management.Automation.PSCredential ($env:SERVER_USER, $secpass)
          
          # 3. Connect securely using Port 5986, -UseSSL, and the defined session options
          $session = New-PSSession -ComputerName $env:SERVER_HOST -Port 5986 -Credential $creds -Authentication Basic -UseSSL -SessionOption $sessionOption

          Write-Host "ðŸ“¦ Uploading build archive to remote server..."
          Copy-Item -ToSession $session -Path "next-build.tar.gz" -Destination "C:\inetpub\wwwroot\next-app\next-build.tar.gz" -Force

          Invoke-Command -Session $session -ScriptBlock {
            $deployPath = "C:\inetpub\wwwroot\next-app"
            Write-Host "ðŸ”§ Preparing deploy folder..."
            if (!(Test-Path $deployPath)) {
              New-Item -ItemType Directory -Path $deployPath | Out-Null
            }

            Set-Location $deployPath
            Write-Host "ðŸ“‚ Extracting build..."
            
            # Clean up old .next folder before extracting new one
            if (Test-Path ".next") { Remove-Item .next -Recurse -Force }
            # Clean up old package.json (if included in the tar)
            if (Test-Path "package.json") { Remove-Item package.json -Force }

            tar -xzf next-build.tar.gz
            Remove-Item next-build.tar.gz -Force
            Write-Host "âœ… Build extracted successfully."
            
            # Reinstall dependencies if they aren't included in the tar (best practice)
            Write-Host "âš™ï¸ Installing dependencies on remote server..."
            npm install --production

            Write-Host "ðŸ”„ Restarting Next.js app with PM2..."
            # Check if PM2 process exists and restart, otherwise start new
            pm2 restart next-app -f -s 2>$null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "App not found â€” starting a new PM2 process."
              # Starts the app using the 'start' script defined in package.json
              pm2 start npm --name "next-app" -- run start
            }

            # Log deployment timestamp
            $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            Add-Content "$deployPath\deploy-log.txt" "Deployed at $timestamp"
            Write-Host "ðŸš€ Deployment completed and logged."
          }

          Remove-PSSession $session