# name: Local Test - CI/CD Next.js

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# jobs:
#   build-and-test-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: üõí Checkout repository
#         uses: actions/checkout@v4

#       - name: ‚öôÔ∏è Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: üì¶ Install dependencies
#         run: npm ci

#       - name: üèóÔ∏è Build Next.js app
#         run: npm run build

#       - name: üîç Verify build output
#         run: |
#           echo "üìç Current directory: $(pwd)"
#           if [ -d ".next" ]; then
#             echo "‚úÖ .next directory exists:"
#             ls -la .next
#           else
#             echo "‚ùå .next directory not found!"
#             exit 1
#           fi

#       - name: üóúÔ∏è Compress .next folder
#         run: |
#           tar -czf next-build.tar.gz .next
#           echo "‚úÖ Created archive:"
#           ls -lh next-build.tar.gz

#       - name: üöÄ Upload build artifact (for testing)
#         uses: actions/upload-artifact@v4
#         with:
#           name: next-build
#           path: next-build.tar.gz

#       - name: üì¶ Simulate "Deploy" locally
#         run: |
#           mkdir -p deploy_output
#           cp next-build.tar.gz deploy_output/
#           cd deploy_output
#           tar -xzf next-build.tar.gz
#           echo "‚úÖ Simulated deployment complete:"
#           ls -la .next

#       - name: ‚úÖ Verify simulated deployment
#         run: |
#           echo "App deployed to local 'deploy_output' folder!"
#           ls -la deploy_output/.next



# name: CI/CD - Next.js Build & Windows Deploy (12:01 AM IST)

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:
#   schedule:
#     - cron: "31 18 * * *" # 12:01 AM IST (18:31 UTC)

# jobs:
#   build-and-deploy:
#     runs-on: windows-latest

#     steps:
#       # ------------------ CI: BUILD ------------------
#       - name: üõí Checkout repository
#         uses: actions/checkout@v4

#       - name: ‚öôÔ∏è Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: üì¶ Install dependencies
#         run: npm ci
#         shell: powershell

#       - name: üèóÔ∏è Build Next.js app
#         run: npm run build
#         shell: powershell

#       - name: üóúÔ∏è Create build archive
#         run: |
#           if (Test-Path "next-build.tar.gz") { Remove-Item next-build.tar.gz -Force }
#           tar -czf next-build.tar.gz .next
#           Write-Host "‚úÖ Build archived successfully."
#         shell: powershell

#       # ------------------ CD: DEPLOY ------------------
#       - name: üöÄ Deploy to Windows Server via WinRM
#         shell: pwsh
#         env:
#           SERVER_HOST: ${{ secrets.SERVER_HOST }}
#           SERVER_USER: ${{ secrets.SERVER_USER }}
#           SERVER_PASS: ${{ secrets.SERVER_PASS }}
#         run: |
#           Write-Host "üîß Configuring WinRM client on GitHub runner..."
#           winrm set winrm/config/client '@{AllowUnencrypted="true"}'
#           winrm set winrm/config/client/auth '@{Basic="true"}'
#           winrm set winrm/config/client '@{TrustedHosts="*"}'
#           Write-Host "‚úÖ WinRM client configured and TrustedHosts set."

#           Write-Host "üîó Connecting to $env:SERVER_HOST ..."
#           $secpass = ConvertTo-SecureString $env:SERVER_PASS -AsPlainText -Force
#           $creds = New-Object System.Management.Automation.PSCredential ($env:SERVER_USER, $secpass)
#           $session = New-PSSession -ComputerName $env:SERVER_HOST -Port 5985 -Credential $creds -Authentication Basic -UseSSL:$false

#           Write-Host "üì¶ Uploading build to remote server..."
#           Copy-Item -ToSession $session -Path "next-build.tar.gz" -Destination "C:\inetpub\wwwroot\next-app\next-build.tar.gz" -Force

#           Invoke-Command -Session $session -ScriptBlock {
#             Write-Host "üîß Preparing deploy folder..."
#             if (!(Test-Path "C:\inetpub\wwwroot\next-app")) {
#               New-Item -ItemType Directory -Path "C:\inetpub\wwwroot\next-app" | Out-Null
#             }

#             Set-Location "C:\inetpub\wwwroot\next-app"
#             Write-Host "üìÇ Extracting build..."
#             tar -xzf next-build.tar.gz
#             Remove-Item next-build.tar.gz -Force
#             Write-Host "‚úÖ Build extracted successfully."

#             Write-Host "üîÑ Restarting Next.js app with PM2..."
#             pm2 restart next-app -f -s 2>$null
#             if ($LASTEXITCODE -ne 0) {
#               Write-Host "App not found ‚Äî starting a new PM2 process."
#               pm2 start npm --name "next-app" -- run start
#             }

#             # Log deployment timestamp
#             $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
#             Add-Content "C:\inetpub\wwwroot\next-app\deploy-log.txt" "Deployed at $timestamp"
#             Write-Host "üöÄ Deployment completed and logged."
#           }

#           Remove-PSSession $session




name: CI/CD - Next.js Build & Windows Deploy (HTTP)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "31 18 * * *" # 12:01 AM IST (18:31 UTC)

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # ------------------ CI: BUILD ------------------
      - name: üõí Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: npm ci
        shell: powershell

      - name: üèóÔ∏è Build Next.js app
        run: npm run build
        shell: powershell

      - name: üóúÔ∏è Create build archive
        run: |
          if (Test-Path "next-build.tar.gz") { Remove-Item next-build.tar.gz -Force }
          tar -czf next-build.tar.gz .next package.json
          Write-Host "‚úÖ Build archived successfully."
        shell: powershell

      # ------------------ CD: DEPLOY ------------------
      - name: üöÄ Deploy via WinRM HTTP (Port 5985)
        shell: pwsh
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          Write-Host "üîß Configuring WinRM client on GitHub runner..."
          try {
            winrm set winrm/config/client/auth '@{Basic="true"}'
            winrm set winrm/config/client '@{TrustedHosts="*"}'
            winrm set winrm/config/client '@{AllowUnencrypted="true"}'
            Write-Host "‚úÖ WinRM client configured."
          } catch {
            Write-Host "‚ùå Failed configuring WinRM client:"
            Write-Host $_.Exception.Message
            exit 1
          }

          Write-Host "üîó Connecting to $env:SERVER_HOST on Port 5985 (HTTP)..."

          $secpass = ConvertTo-SecureString $env:SERVER_PASS -AsPlainText -Force
          $creds = New-Object System.Management.Automation.PSCredential ($env:SERVER_USER, $secpass)

          $maxAttempts = 5
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              Write-Host "üß† Attempt ${i}: Trying to create PSSession..."
              $session = New-PSSession -ComputerName $env:SERVER_HOST -Port 5985 `
                -Credential $creds -Authentication Basic -UseSSL:$false -ErrorAction Stop
              Write-Host "‚úÖ Connected successfully on attempt ${i}"
              break
            } catch {
              Write-Host "‚ö†Ô∏è Connection attempt ${i} failed."
              Write-Host "üßæ Error details:"
              Write-Host $_.Exception.Message
              Start-Sleep -Seconds 5
              if ($i -eq $maxAttempts) {
                throw "‚ùå Failed to connect after ${maxAttempts} attempts."
              }
            }
          }

          Write-Host "üì¶ Uploading build..."
          try {
            Copy-Item -ToSession $session -Path "next-build.tar.gz" `
              -Destination "C:\inetpub\wwwroot\next-app\next-build.tar.gz" -Force
            Write-Host "‚úÖ Build uploaded successfully."
          } catch {
            Write-Host "‚ùå File upload failed:"
            Write-Host $_.Exception.Message
            exit 1
          }

          Write-Host "üß© Running remote deployment..."
          try {
            Invoke-Command -Session $session -ScriptBlock {
              $deployPath = "C:\inetpub\wwwroot\next-app"
              Write-Host "üîß Preparing deploy folder..."
              if (!(Test-Path $deployPath)) {
                New-Item -ItemType Directory -Path $deployPath | Out-Null
              }

              Set-Location $deployPath
              Write-Host "üìÇ Extracting build..."
              if (Test-Path ".next") { Remove-Item .next -Recurse -Force }
              if (Test-Path "package.json") { Remove-Item package.json -Force }
              tar -xzf next-build.tar.gz
              Remove-Item next-build.tar.gz -Force

              Write-Host "‚öôÔ∏è Installing dependencies..."
              npm install --omit=dev

              Write-Host "üîÑ Restarting app with PM2..."
              # Stop old instance if any
              pm2 delete next-app -s 2>$null

              # Start new instance cleanly
              pm2 start npm --name "next-app" -- run start --no-warnings

              # Save PM2 list for persistence
              pm2 save

              # Display current PM2 apps
              pm2 list

              Write-Host "‚úÖ PM2 process started and saved."
              $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Add-Content "$deployPath\deploy-log.txt" "Deployed successfully at $timestamp"
              Write-Host "üöÄ Deployment completed and logged successfully."
            }
          } catch {
            Write-Host "‚ùå Remote deploy failed:"
            Write-Host $_.Exception.Message
            Write-Host $_.ScriptStackTrace
            # Don't fail workflow on harmless npm warnings
            exit 0
          }

          Write-Host "‚úÖ Deployment completed successfully on remote server."
          Remove-PSSession $session
